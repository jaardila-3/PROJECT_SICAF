@using static SICAF.Common.Constants.UserConstants
@model CourseDto

<div class="row">
    <!-- Información del programa -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-success">
                <h5 class="mb-0 text-white">
                    <i class="ti ti-school me-2"></i>
                    Información del Programa
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h3 class="text-primary">
                        <span class="badge bg-dark">@Model.CourseNumber</span>
                    </h3>
                    <h4>@Model.CourseName</h4>
                    <span class="badge @Model.StatusBadgeClass">@Model.StatusCourse</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <tbody>
                            <tr>
                                <td><strong>Descripción:</strong></td>
                                <td>@Model.Description</td>
                            </tr>
                            <tr>
                                <td><strong>Fecha de Inicio:</strong></td>
                                <td>@Model.StartDate.ToString("dd/MM/yyyy")</td>
                            </tr>
                            <tr>
                                <td><strong>Fecha de Fin:</strong></td>
                                <td>
                                    <span id="endDateDisplay">@Model.EndDate.ToString("dd/MM/yyyy")</span>
                                    @if (User.IsInRole(SystemRoles.ACADEMIC_ADMIN))
                                    {
                                        <button type="button" class="btn btn-sm btn-warning ms-2" data-bs-toggle="modal"
                                            data-bs-target="#editEndDateModal">
                                            <i class="ti ti-edit"></i>
                                        </button>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Total Estudiantes Activos:</strong></td>
                                <td><span class="badge bg-success">@Model.ActiveStudentsCount</span></td>
                            </tr>
                            <tr>
                                <td><strong>Total Lideres Inscritos:</strong></td>
                                <td><span class="badge bg-info">@Model.EnrolledLeadersCount</span></td>
                            </tr>
                            <tr>
                                <td><strong>Total instructores Inscritos:</strong></td>
                                <td><span class="badge bg-info">@Model.EnrolledInstructorsCount</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista Completa de Estudiantes para Administradores -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary">
                <h5 class="mb-0 text-white">
                    <i class="ti ti-users me-2"></i>
                    Gestión de Estudiantes
                </h5>
            </div>
            <div class="card-body">
                @if (Model.UserCourses.Any())
                {
                    <!-- Tabla de estudiantes -->
                    <div class="table-responsive">
                        <table class="datatablesAdvancedJQuery table table-hover">
                            <thead>
                                <tr>
                                    <th class="text-center">Identificación</th>
                                    <th class="text-center">Nombre</th>
                                    <th class="text-center">Ala</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var student in Model.UserCourses.OrderBy(x => x.User?.GradeOrder).ThenBy(x =>
                                                            x.User?.SeniorityOrder))
                                {
                                    <tr>
                                        <td class="text-center small">@student.User?.FullIdentification</td>
                                        <td>@student.User?.FullName</td>
                                        <td class="text-center">
                                            @if (student.StudentWingType == AviationConstants.WingTypes.FIXED_WING)
                                            {
                                                <span class="badge bg-primary">
                                                    <i class="ti ti-plane me-1"></i>F
                                                </span>
                                            }
                                            else if (student.StudentWingType == AviationConstants.WingTypes.ROTARY_WING)
                                            {
                                                <span class="badge bg-info">
                                                    <i class="ti ti-propeller me-1"></i>R
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">N/A</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span
                                                class="badge @StudentStatus.GetStatusBadgeClass(student.Status)">@student.Status
                                            </span>
                                        </td>
                                        <td class="text-center">

                                            <a asp-action="Details" asp-controller="User" asp-area="Identity"
                                                asp-route-id="@student.UserId" asp-route-courseId="@Model.Id"
                                                class="btn btn-sm btn-info" title="Ver Estudiante">
                                                <i class="ti ti-user"></i>
                                            </a>

                                            @if (student.IsActive && student.Status == StudentStatus.Active)
                                            {
                                                <a asp-action="ChangeCourse" asp-route-studentId="@student.UserId"
                                                    class="btn btn-sm btn-warning text-white" title="Cambiar de Programa">
                                                    <i class="ti ti-switch-horizontal"></i>
                                                </a>
                                            }

                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info text-center" role="alert">
                        <i class="ti ti-info-circle me-2"></i>
                        No hay estudiantes inscritos en este programa.
                    </div>
                }
            </div>
        </div>

        <!-- Gestión de Instructores -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-white">
                                <i class="ti ti-school me-2"></i>
                                Instructores y Líder de Vuelo Asignados
                            </h5>
                            @if (User.IsInRole(SystemRoles.ACADEMIC_ADMIN))
                            {
                                <div>
                                    <a asp-action="AssignInstructors" asp-route-courseId="@Model.Id"
                                        class="btn btn-sm btn-outline-warning">
                                        <i class="ti ti-user-plus me-1"></i>Asignar Instructores
                                    </a>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="instructorsTable" data-course-id="@Model.Id">
                            <!-- Se carga por AJAX -->
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando instructores...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar fecha de finalización -->
@if (User.IsInRole(SystemRoles.ACADEMIC_ADMIN))
{
    <div class="modal fade" id="editEndDateModal" tabindex="-1" aria-labelledby="editEndDateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success">
                    <h5 class="modal-title text-white" id="editEndDateModalLabel">
                        <i class="ti ti-calendar-event me-2"></i>Editar Fecha de Finalización
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form id="updateEndDateForm" data-course-id="@Model.Id"
                    data-course-start-date="@Model.StartDate.ToString("yyyy-MM-dd")"
                    data-update-url="@Url.Action("UpdateEndDate", "Course")">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="newEndDate" class="form-label">Nueva Fecha de Finalización</label>
                            <input type="text" class="form-control" id="newEndDate"
                                value="@Model.EndDate.ToString("yyyy-MM-dd")" min="@Model.StartDate.ToString("yyyy-MM-dd")"
                                required>
                            <div class="form-text">La fecha debe ser posterior a la fecha de inicio del programa.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="ti ti-device-floppy me-1"></i>Actualizar Fecha
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}