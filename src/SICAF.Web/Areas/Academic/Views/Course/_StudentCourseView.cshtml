@using static SICAF.Common.Constants.UserConstants
@model CourseDto

@{
    var report = Model.StudentReport;
}

@if (report == null)
{
    <div class="alert alert-warning" role="alert">
        <i class="ti ti-alert-circle me-2"></i>
        No se pudo cargar la información del estudiante.
    </div>
    return;
}

<div class="row">
    <!-- Información del Programa y Estudiante -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-success">
                <h5 class="mb-0 text-white">
                    <i class="ti ti-school me-2"></i>
                    Mi Programa
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h4>@Model.CourseName</h4>
                    <span class="badge @Model.StatusBadgeClass">@Model.StatusCourse</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <tbody>
                            <tr>
                                <td><strong>Fecha de Inicio:</strong></td>
                                <td>@Model.StartDate.ToString("dd/MM/yyyy")</td>
                            </tr>
                            <tr>
                                <td><strong>Fecha de Fin:</strong></td>
                                <td>@Model.EndDate.ToString("dd/MM/yyyy")</td>
                            </tr>
                            <tr>
                                <td><strong>Mi Estado:</strong></td>
                                <td>
                                    <span
                                        class="badge @StudentStatus.GetStatusBadgeClass(report.StudentStatus)">@report.StudentStatusDisplay
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Tipo de Ala:</strong></td>
                                <td>
                                    @if (report.WingType == AviationConstants.WingTypes.FIXED_WING)
                                    {
                                        <span class="badge bg-primary">
                                            <i class="ti ti-plane me-1"></i>ALA FIJA
                                        </span>
                                    }
                                    else if (report.WingType == AviationConstants.WingTypes.ROTARY_WING)
                                    {
                                        <span class="badge bg-info">
                                            <i class="ti ti-propeller me-1"></i>ALA ROTATORIA
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@report.WingType</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Fuerza:</strong></td>
                                <td>@report.Force</td>
                            </tr>
                            <tr>
                                <td><strong>PID:</strong></td>
                                <td><span class="badge bg-dark">@report.PID</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Progreso Académico -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-primary">
                <h5 class="mb-0 text-white">
                    <i class="ti ti-chart-line me-2"></i>
                    Mi Progreso Académico
                </h5>
            </div>
            <div class="card-body">
                <!-- Estadísticas Principales -->
                <div class="row text-center mb-3">
                    <div class="col-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h3 class="text-success mb-1">@report.TotalFlightHours</h3>
                            <small class="text-muted">Horas de Vuelo</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h3 class="text-success mb-1">@report.Average.ToString("F2")</h3>
                            <small class="text-muted">Promedio Académico</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h5 class="text-info mb-1">@(report.CurrentPhase ?? "N/A")</h5>
                            <small class="text-muted">Fase Actual</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h3 class="text-info mb-1">@report.PhasesCompleted</h3>
                            <small class="text-muted">Fases Completadas</small>
                        </div>
                    </div>
                </div>

                <!-- Progreso de Misiones -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Progreso General del Programa</small>
                        <strong>@report.TotalCourseProgressPercentage.ToString("F1")%</strong>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" role="progressbar"
                            style="width: @string.Format(System.Globalization.CultureInfo.InvariantCulture, "{0}%", report.TotalCourseProgressPercentage)"
                            aria-valuenow="@report.TotalCourseProgressPercentage" aria-valuemin="0" aria-valuemax="100">
                            @report.TotalMissionsCompleted / @report.TotalMissionsInCourse
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(report.CurrentPhase))
                {
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Progreso Fase Actual</small>
                            <strong>@report.CurrentPhaseProgressPercentage.ToString("F1")%</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" role="progressbar"
                                style="width: @string.Format(System.Globalization.CultureInfo.InvariantCulture, "{0}%", report.CurrentPhaseProgressPercentage)"
                                aria-valuenow="@report.CurrentPhaseProgressPercentage" aria-valuemin="0"
                                aria-valuemax="100">
                                @report.CurrentPhaseMissionsCompleted / @report.CurrentPhaseTotalMissions
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Distribución de Calificaciones -->
<div class="row mt-3">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-success">
                <h5 class="mb-0 text-white">
                    <i class="ti ti-chart-bar me-2"></i>
                    Distribución de Calificaciones
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4 mb-3">
                        <div class="border rounded p-2">
                            <h4 class="text-success mb-1">@report.GradeDistribution.GradeA</h4>
                            <small class="text-muted">Calificación A</small>
                        </div>
                    </div>
                    <div class="col-4 mb-3">
                        <div class="border rounded p-2">
                            <h4 class="text-info mb-1">@report.GradeDistribution.GradeB</h4>
                            <small class="text-muted">Calificación B</small>
                        </div>
                    </div>
                    <div class="col-4 mb-3">
                        <div class="border rounded p-2">
                            <h4 class="text-primary mb-1">@report.GradeDistribution.GradeC</h4>
                            <small class="text-muted">Calificación C</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <h4 class="text-warning mb-1">@report.GradeDistribution.GradeN</h4>
                            <small class="text-muted">Calificación N</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <h4 class="text-danger mb-1">@report.GradeDistribution.GradeNR</h4>
                            <small class="text-muted">Calificación N-Roja</small>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <p class="mb-0">
                        <strong>Total de Calificaciones: </strong>
                        <span class="badge bg-dark">@report.GradeDistribution.TotalGrades</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Adicionales -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-primary">
                <h5 class="mb-0 text-white">
                    <i class="ti ti-trophy me-2"></i>
                    Resumen de Desempeño
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h4 class="text-success mb-1">
                                @report.UnsatisfactoryMissions.Count(m => true)
                            </h4>
                            <small class="text-muted">Misiones Insatisfactorias</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h4 class="text-primary mb-1">
                                @(report.TotalMissionsCompleted - report.UnsatisfactoryMissions.Count)
                            </h4>
                            <small class="text-muted">Misiones Satisfactorias</small>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h4 class="text-warning mb-1">@report.AcademicCommittees.Count</h4>
                            <small class="text-muted">Comités Académicos</small>
                        </div>
                    </div>
                </div>

                @if (report.NonEvaluableMissionRecords > 0)
                {
                    <div class="alert alert-info mb-0" role="alert">
                        <i class="ti ti-info-circle me-2"></i>
                        <strong>Registros No Evaluables:</strong> @report.NonEvaluableMissionRecords
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Sección de Misiones Insatisfactorias (solo si hay) -->
@if (report.UnsatisfactoryMissions.Any())
{
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info">
                    <h5 class="mb-0 text-white">
                        <i class="ti ti-alert-triangle me-2"></i>
                        Misiones Insatisfactorias Recientes
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Fase</th>
                                    <th>Misión</th>
                                    <th>Instructor</th>
                                    <th>Aeronave</th>
                                    <th>Tareas N-Roja</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var mission in report.UnsatisfactoryMissions.OrderByDescending(m =>
                                                            m.Date))
                                {
                                    <tr>
                                        <td>@mission.Date.ToString("dd/MM/yyyy")</td>
                                        <td>@mission.Phase</td>
                                        <td>@mission.Mission</td>
                                        <td>@mission.InstructorGradeAndName</td>
                                        <td>@mission.AircraftRegistration</td>
                                        <td>
                                            @foreach (var item in mission.TasksWithNRed)
                                            {
                                                @item
                                                <br />
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Sección de Comités Académicos (solo si hay) -->
@if (report.AcademicCommittees.Any())
{
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0 text-white">
                        <i class="ti ti-gavel me-2"></i>
                        Comités Académicos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Número de Acta</th>
                                    <th>Fecha</th>
                                    <th>Decisión</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var committee in report.AcademicCommittees.OrderByDescending(c => c.Date))
                                {
                                    <tr>
                                        <td><strong>@committee.ActNumber</strong></td>
                                        <td>@committee.Date.ToString("dd/MM/yyyy")</td>
                                        <td>
                                            @if (committee.Decision == CommitteeDecisions.ContinueCourse)
                                            {
                                                <span class="badge bg-success">@committee.Decision</span>
                                            }
                                            else if (committee.Decision == CommitteeDecisions.Suspendecourse)
                                            {
                                                <span class="badge bg-danger">@committee.Decision</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@committee.Decision</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(committee.Observations))
                                            {
                                                <small>@committee.Observations</small>
                                            }
                                            else
                                            {
                                                <small class="text-muted">Sin observaciones</small>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Información Importante -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success">
                <h5 class="mb-0 text-white">
                    <i class="ti ti-info-circle me-2"></i>
                    Información Importante
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3" role="alert">
                    <h6 class="alert-heading">
                        <i class="ti ti-bulb me-2"></i>Recordatorio Académico
                    </h6>
                    <p class="mb-0">
                        Recuerda revisar regularmente tu progreso y estar al día con las fases de entrenamiento.
                        Si tienes dudas sobre alguna calificación o necesitas apoyo adicional,
                        no dudes en contactar a tu instructor asignado.
                    </p>
                </div>

                @if (!string.IsNullOrEmpty(report.CurrentPhase) && report.CurrentPhaseMissionsPending > 0)
                {
                    <div class="alert alert-warning mb-0" role="alert">
                        <h6 class="alert-heading">
                            <i class="ti ti-clock me-2"></i>Progreso Actual
                        </h6>
                        <ul class="mb-0">
                            <li>Fase Actual: <strong>@report.CurrentPhase</strong></li>
                            <li>Misiones Completadas: <strong>@report.CurrentPhaseMissionsCompleted de
                                    @report.CurrentPhaseTotalMissions</strong></li>
                            <li>Misiones Pendientes: <strong>@report.CurrentPhaseMissionsPending</strong></li>
                        </ul>
                    </div>
                }
                else if (string.IsNullOrEmpty(report.CurrentPhase))
                {
                    <div class="alert alert-secondary mb-0" role="alert">
                        <h6 class="alert-heading">
                            <i class="ti ti-info-circle me-2"></i>Estado
                        </h6>
                        <p class="mb-0">
                            @if (report.StudentStatus == StudentStatus.CourseCompleted)
                            {
                                <text>¡Felicitaciones! Has completado exitosamente el programa.</text>
                            }
                            else if (report.StudentStatus == StudentStatus.Suspended)
                            {
                                <text>Actualmente te encuentras suspendido. Contacta con el área académica para más
                                    información.</text>
                            }
                            else
                            {
                                <text>Aún no tienes una fase asignada. Contacta con el área académica.</text>
                            }
                        </p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Acordeones de Misiones por Fase -->
<partial name="_StudentPhaseAccordions" model="Model.StudentReport" />