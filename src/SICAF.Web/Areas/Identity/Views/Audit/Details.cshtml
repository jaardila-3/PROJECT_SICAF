@model AuditInfoDto

@{
    ViewData["Title"] = "Detalles de Auditoría";
}

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb rounded">
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Home", new { area = "" })" class="text-success d-flex align-items-center">
                <i class="ti ti-home fs-4 mt-1"></i>
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Audit")" class="text-success">Auditoría</a>
        </li>
        <li class="breadcrumb-item text-success active" aria-current="page">Detalles</li>
    </ol>
</nav>

<div class="row">
    <!-- Información General -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-primary">
                <h5 class="mb-0 text-white">
                    <i class="ti ti-file-info me-2"></i>
                    Información General
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <tbody>
                            <tr>
                                <td><strong>ID del Registro:</strong></td>
                                <td><code>@Model.Id</code></td>
                            </tr>
                            <tr>
                                <td><strong>Fecha y Hora:</strong></td>
                                <td>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")</td>
                            </tr>
                            <tr>
                                <td><strong>Operación:</strong></td>
                                <td>
                                    <span class="badge @GetOperationBadgeClass(Model.OperationType)">
                                        @Model.OperationType
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>ID de Entidad:</strong></td>
                                <td><code>@Model.EntityId</code></td>
                            </tr>
                            @if (Model.AffectedUserId.HasValue)
                            {
                                <tr>
                                    <td><strong>Usuario Afectado:</strong></td>
                                    <td>
                                        <span class="text-info">@(Model.AffectedUserIdentificationName ?? "N/A")</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Información del Usuario -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-success">
                <h5 class="mb-0 text-white">
                    <i class="ti ti-user me-2"></i>
                    Información del Usuario Ejecutor
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <tbody>
                            <tr>
                                <td><strong>Usuario:</strong></td>
                                <td>
                                    @if (!string.IsNullOrEmpty(Model.UserName))
                                    {
                                        <span class="text-primary">@Model.UserName</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Sistema</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Rol:</strong></td>
                                <td>@(Model.UserRole ?? "N/A")</td>
                            </tr>
                            <tr>
                                <td><strong>Dirección IP:</strong></td>
                                <td>@(Model.IpAddress ?? "N/A")</td>
                            </tr>
                            <tr>
                                <td><strong>Módulo:</strong></td>
                                <td>@(Model.Module ?? "N/A")</td>
                            </tr>
                            <tr>
                                <td><strong>Controlador:</strong></td>
                                <td>@(Model.Controller ?? "N/A")</td>
                            </tr>
                            <tr>
                                <td><strong>Acción:</strong></td>
                                <td>@(Model.Action ?? "N/A")</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Valores Anteriores y Nuevos -->
@if (Model.HasOldValues || Model.HasNewValues)
{
    <div class="row mt-3">
        @if (Model.HasOldValues)
        {
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-success">
                        <h5 class="mb-0 text-white">
                            <i class="ti ti-history me-2"></i>
                            Valores Anteriores
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="code-container p-3" data-simplebar style="height: 400px">
                            <pre class="code-view"><code class="language-json">@FormatJson(Model.OldValues)</code></pre>
                        </div>

                    </div>
                </div>
            </div>
        }

        @if (Model.HasNewValues)
        {
            <div class="@(Model.HasOldValues ? "col-lg-6" : "col-12")">
                <div class="card">
                    <div class="card-header bg-primary">
                        <h5 class="mb-0 text-white">
                            <i class="ti ti-file-plus me-2"></i>
                            Valores Nuevos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="code-container p-3" data-simplebar style="height: 400px">
                            <pre class="code-view"><code class="language-json">@FormatJson(Model.NewValues)</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

<div class="mt-3">
    <a asp-action="Index" class="btn btn-secondary mb-3">
        <i class="ti ti-arrow-left me-2"></i>Volver al Listado
    </a>
</div>

@functions {
    private string GetOperationBadgeClass(string operationType)
    {
        return operationType switch
        {
            DatabaseOperationType.Create => "bg-success",
            DatabaseOperationType.Update => "bg-warning",
            DatabaseOperationType.Delete => "bg-danger",
            DatabaseOperationType.Read => "bg-info",
            DatabaseOperationType.Login => "bg-primary",
            DatabaseOperationType.Lock => "bg-danger",
            DatabaseOperationType.Unlock => "bg-success",
            DatabaseOperationType.AdminResetPassword or DatabaseOperationType.ChangePassword => "bg-warning",
            _ => "bg-secondary"
        };
    }

    private string FormatJson(string? json)
    {
        if (string.IsNullOrWhiteSpace(json))
            return "{}";

        try
        {
            var parsedJson = System.Text.Json.JsonSerializer.Deserialize<object>(json);

            // Configurar opciones para no escapar caracteres Unicode
            var options = new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true,
                // No escapar caracteres no ASCII
                Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
            };

            return System.Text.Json.JsonSerializer.Serialize(parsedJson, options);
        }
        catch
        {
            return json;
        }
    }
}

@section Styles {
    <link rel="stylesheet" href="~/assets/css/plugins/atom-one-dark.min.css" />
}

@section Scripts {
    <!-- highlight.js (code view) -->
    <script src="~/assets/js/highlights/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
        document.querySelectorAll("pre.code-view > code").forEach((codeBlock) => {
            codeBlock.textContent = codeBlock.innerHTML;
        });
    </script>
}